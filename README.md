# Travelr

Travelr is a personal trip planner with a Node.js + TypeScript API (`server/`) and a lit-based TypeScript client (`client/`). The backend replays slash-command journals to rebuild a `TripModel`, while the frontend provides a column-based UI for inspecting and editing activities.

## Prerequisites

Install these in order:

- Git
- Node.js 24+ (includes npm)
- Docker Desktop (for containerized deployment)
- AWS CLI (for cloud deployment - use `winget install Amazon.AWSCLI`)
- VS Code (recommended)

## Quick Start

```powershell
# 1. Clone and install
git clone https://github.com/kdemarest/travelr.git
cd travelr
npm install

# 2. Set up API keys in Windows Credential Manager (see "API Keys" below)

# 3. Configure your environment
node setup.js

# 4. Launch the app
launch.bat
```

## Developer Overview

### Scripts

| Script | Purpose |
|--------|---------|
| `node setup.js` | Detects your environment and sets `TRAVELR_CONFIG` permanently |
| `launch.bat` | Builds and runs both server and client for local development |
| `node deploy.js` | Builds Docker image, pushes to ECR, deploys to AWS App Runner |
| `node deploy.js --dry-run` | Shows what deploy would do without making changes |

### Configuration

The app uses environment-specific config files in `dataConfig/`:

- `config.dev-win11.json` – Local Windows development
- `config.prod-debian.json` – Production Docker/Linux

The `TRAVELR_CONFIG` environment variable (set by `setup.js`) determines which config file is loaded.

### API Keys

Set these environment variables (User environment variables recommended):

| Variable | Description |
|----------|-------------|
| `TRAVELR_CONFIG` | which config.<TRAVELR_CONFIG>.json config to use |
| `OPENAI_API_KEY` | ChatGPT API key |
| `GOOGLE_CS_API_KEY` | Google Custom Search API key |
| `GOOGLE_CS_CX` | Google Programmable Search Engine ID |
| `TRAVELR_DEPLOYBOT_PWD` | Deploybot password for deploy script admin operations |
| `TRAVELR_TESTBOT_PWD` | Test user password for running auth unit tests |

To set using setup.js:
```bash
node setup.js dev (or prod)
node setup.js OPENAI_API_KEY sk-proj-xxx
node setup.js GOOGLE_CS_API_KEY AIzaSyxxx
node setup.js GOOGLE_CS_CX your-search-engine-id
node setup.js TRAVELR_DEPLOYBOT_PWD your-deploybot-password
node setup.js TRAVELR_TESTBOT_PWD your-test-password
```

Restart your terminal after setting variables.

## Running Locally

**Windows:** Use `launch.bat`

**Manual (any OS):**
```bash
npm run build --workspace server
npm run build --workspace client
npm run dev --workspace server   # Terminal 1
npm run dev --workspace client   # Terminal 2
```

Vite serves the client at `http://localhost:5173`, proxying `/api` calls to the server on port 4000.

## Deploying to AWS

### AWS CLI Setup

1. Install AWS CLI: `winget install Amazon.AWSCLI`
2. Create an IAM user (`kdemarest`) with `AdministratorAccess` policy
3. Create access keys for the user (CLI use case)
4. Configure the CLI:
   ```bash
   aws configure
   ```
   - Region: `us-east-1`
   - Output format: `json`

### Deploy

```bash
# Test deployment (no changes made)
node deploy.js --dry-run

# Full deployment
node deploy.js
```

The deploy script:
1. Reads secrets from environment variables
2. Builds the Docker image
3. Pushes to Amazon ECR
4. Deploys to AWS App Runner

## Project Layout

| Directory | Purpose |
|-----------|---------|
| `server/` | Express API, journal parser, trip model reducer |
| `client/` | Vite + Lit frontend components |
| `scripts/` | Utility scripts (password hashing, file persistence) |
| `dataTrips/` | Trip journals (`*.travlrjournal`) |
| `dataUsers/` | User accounts and auth data |
| `dataDiagnostics/` | Debug logs (`last_request.txt`, etc.) |
| `dataConfig/` | Environment configs and prompt template |
| `catalog/` | Static reference data (countries, exchange rates) |
| `deploy/` | Dockerfile and docker-compose for deployment |

## User Management

User accounts are stored in `dataUsers/users.json`. Passwords are hashed using scrypt.

### Adding a New User

1. Generate a password hash:
   ```bash
   npx ts-node scripts/hashPassword.ts "mySecurePassword"
   ```

2. Add the user to `dataUsers/users.json`:
   ```json
   {
     "username": { "password": "<paste-hash-here>", "isAdmin": false }
   }
   ```

### User Format

```json
{
  "username": {
    "password": "salt:hash",
    "isAdmin": true
  }
}
```

- `password`: scrypt hash in `salt:hash` format (generated by `hashPassword.ts`)
- `isAdmin`: optional, grants access to admin endpoints

## Slash Commands

| Command | Description |
|---------|-------------|
| `/newtrip <tripId>` | Initialize or reset a trip journal |
| `/add activityType=<type> field=value ...` | Add a new activity |
| `/edit <uid> field=value ...` | Update an existing activity |
| `/movedate from="YYYY-MM-DD" to="YYYY-MM-DD"` | Move all activities on a date |
| `/undo [count]` | Step backward through journal history |
| `/redo [count]` | Reapply undone commands |
| `/trip [tripId]` | List trips or load a specific trip |
| `/help` | Show available commands |
- Add VS Code launch/debug configuration once the API endpoints stabilize.
